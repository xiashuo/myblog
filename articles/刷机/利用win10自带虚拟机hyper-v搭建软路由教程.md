<div class="blog-article">
    <h1><a href="p.html?p=\刷机\利用win10自带虚拟机hyper-v搭建软路由教程" class="title">利用win10自带虚拟机hyper-v搭建软路由教程</a></h1>
    <span class="author">xiashuobad</span>
    <span class="time">2020-03-09 16:35</span>
    <span><a href="tags.html?t=刷机" class="tag">刷机</a></span>
    </div>
<br/>

> 最近迷上了折腾路由器，折腾完了硬路由又开始玩起软路由了(*^_^*)。因为之前在家里
> 裴讯k1上测试`v2ray`和`trojan`都因为内存太小而没有跑起来，所以打算用虚拟机搭建一个
> 软路由来测试一下性能，如果效果好的话，就准备入手一台软路由主机了。 

# 准备工作
## 开启win10虚拟机`hyper-v`
> 开启hyper-v首先得需要电脑cpu支持虚拟化功能。这个开机进入bios查看并开启。
> 开启得方式应该很多，百度一下就能解决。还有一个问题就是系统要求是win10专业版、
> 企业版或更高版本，我得电脑是i7第7代处理器，肯定是支持虚拟机功能的啦，但是
>我的系统装的是win10家庭版，在控制面板程序和功能里无法找到hyper-v选项。当时
>还纠结要不要重装一下系统，幸好在百度上找到了解决办法。如果电脑cpu不支持的话，那就没法
>用hyper-v了，但是可以用第三方的虚拟机，如vm，vbox等也是一样的。只是软路由的配置过程
>有所区别。用自带虚拟机唯一的好处就是兼容性好以及占的资源少一些，但是体验下来个人感觉
>没有vm好用，特别是网络配置这块更复杂一些。 

`win10家庭版开启hyper-v虚拟机的办法：`

将下面的内容复制到记事本中：

```
pushd "%~dp0"

dir /b %SystemRoot%\servicing\Packages\*Hyper-V*.mum >hyper-v.txt

for /f %%i in ('findstr /i . hyper-v.txt 2^>nul') do dism /online /norestart /add-package:"%SystemRoot%\servicing\Packages\%%i"

del hyper-v.txt

Dism /online /enable-feature /featurename:Microsoft-Hyper-V-All /LimitAccess /ALL
```
点击记事本左上角的【文件】，在下拉菜单中点击【另存为】`Hyper-V.cmd`文件。

找到并右键点击【Hyper-V.cmd】文件图标，在右键菜单中点击：以管理员身份运行。

然后弹出一个 用户帐户控制 - Windows命令处理程序 对话框，我们点击：是。

紧接着进行Windows命令处理，我们等待处理完成以后，在最末处输入：Y，电脑自动重启，
进行配置更新。`注意：不能关闭计算机。`

配置更新完成以后，进入系统桌面，我们点击系统桌面左下角的 【开始】，在
Windows管理工具中就能看到Hyper-V管理器程序了。

`注意：以上只是针对win10家庭版的开启办法，专业版或者企业版bios开启虚拟化功能后，直接
在控制面板的程序和功能里就能找到hyper-v，打勾即可开启。`

## 下载软路由固件
> 网上比较流行的固件有很多，我这里实验了koolshare论坛的`lede`和某位大佬自编译的`openwrt`
>固件。

下载地址：
- [lede固件](https://firmware.koolshare.cn/LEDE_X64_fw867/) 下载最新的uefi版本的

![](assets/images/2020/03/lede固件下载.png)

- [openwrt固件](https://pan.baidu.com/s/1-uUL7aTNQ9KOMBiwZf1i-g) 提取码：kay4

这个也是选择最新的uefi版本的就好

## 将固件的格式转换为vhdx格式
> 由于下载的固件包解压后是`img`格式，在虚拟机中是无法直接使用的，所以需要通过一个工具
>将其转换成`hyper-v`可用的格式`vhdx`。

这里用到的转换工具叫做 `StarWind V2V Image Converter`，百度一下就能找到下载地址。

使用也比较简单机械，选择源文件，选择转换的格式，然后一键就搞定了，过程就不截图了。

# 软路由系统安装与配置
## 配置虚拟交换机
首先打开虚拟机管理器，开始配置虚拟交换机。

![](assets/images/2020/03/配置虚拟交换机1.png)

点击新建虚拟网络交换机，选择外部，然后点击创建

![](assets/images/2020/03/配置虚拟交换机2.png)

然后名称随便填，自己能辨认就好，其他默认就行，然后点应用。`需要说明的是`：这里实际上就是
`桥接`模式，`外部网络`这里它会自动选择当前电脑上网的网卡，比如我这里用的是无线上网，它自动
选择的就是无线网卡，如果是有线上网，它就会选择有线网卡。`允许操作系统共享此网络适配器`这里
要打勾，否则后面本机无法联网。

![](assets/images/2020/03/配置虚拟交换机3.png)

## 安装虚拟机系统

虚拟网络交换机配置好了后就可以开始安装虚拟机系统了。点击：新建->虚拟机。

![](assets/images/2020/03/新建.png)

直接下一步。

![](assets/images/2020/03/新建2.png)

填入虚拟机的名称，然后下一步。

![](assets/images/2020/03/新建3.png)

这里选择第二代，因为第二代支持uefi，如果下载的不是uefi而是bombined版本的固件则可以
选择第一代。

![](assets/images/2020/03/新建4.png)

给虚拟机分配内存，这里建议1G就足够用了，任性分配大点也无所谓，把动态内存取消掉。

![](assets/images/2020/03/新建5.png)

配置网络这里选择刚刚创建的那个虚拟网络交换机。

![](assets/images/2020/03/新建6.png)

虚拟硬盘选择现有虚拟硬盘，选择刚刚转换为vhdx格式的固件。然后下一步完成虚拟机的创建。

![](assets/images/2020/03/新建7.png)

这里因为是使用的是vhdx格式的包安装的，创建的时候无法选择虚拟硬盘的大小，所以这里有必要
修改一下虚拟硬盘的大小。选中虚拟机点击：设置。然后选择磁盘驱动器，点击：编辑

![](assets/images/2020/03/新建8.png)

选择操作->拓展

![](assets/images/2020/03/新建9.png)

填写虚拟硬盘的大小，根据自己需要填写。

![](assets/images/2020/03/新建10.png)

设置里还需要关闭一下`安全启动`，否则可能无法正常开机。

![](assets/images/2020/03/新建11.png)

到这里虚拟机安装就结束了

## 软路由的配置

连接并启动虚拟机，启动完成后输出回车，出现如下画面则代表成功。

![](assets/images/2020/03/配置1.png)

软路由固件默认ip地址为`192.168.1.1`，这里首先需要修改软路由的ip地址，具体要根据总路由
的ip地址进行修改，因为软路由默认是静态获取ip的方式，所以软路由ip必须要设置在总路由
的网段下面.比如我家里路由器的ip地址为`192.168.123.1`，所以我这里设置软路由ip为：
`192.168.123.33`。这里最后的33，随便设置，在2-255之间都可以，建议设置小一点，因为
后面软路由ip要作为其他设备的网关地址，所以不能太大，否则后面设备可用的ip地址就少了。

下面开始修改软路由ip，进入虚拟机，输入 `vi etc/config/network` 按`insert`键或者字母
`i`进入编辑模式,找到 `option ipaddr` 这行进行修改。

![](assets/images/2020/03/配置2.png)

修改完成后，按 `esc`，输入`:wq` 保存退出

这个时候打开浏览器，输入上面设置的软路由ip地址：`192.168.123.33` 就可以进入到软路由后台
设置界面了。lede系统的默认登录密码为：`koolshare`，上面网盘提供的openwrt系统的默认
密码为：`password`

![](assets/images/2020/03/配置3.png)

登录进去之后，点击左边的：`网络->接口`，然后在右边对网络接口点击`编辑`。

![](assets/images/2020/03/配置4.png)

这里主要要填写网关地址为家里路由器的ip地址，否则软路由无法上网。dns可以填一下也可以不填
我这里分别填的是谷歌和腾讯的dns。

![](assets/images/2020/03/配置5.png)

填好之后点保存并应用，这时软路由应该已经连上网络了。可以点击：`网络->诊断`，进行联网测试

也可以回到虚拟机中，用`ping`进行测试，出现下面的画面说明网络已经连接成功。

![](assets/images/2020/03/配置6.png)

到这里软路由作为旁路由的基本配置就结束了。

## 设备连接软路由上网的配置

电脑右键点击右下角网络图标，`打开网络和internet设置`，然后点击`更改适配器选项`，
找到虚拟机里创建的那个虚拟网络适配器。

![](assets/images/2020/03/配置7.png)

`右键->属性`，双击 `tcp/ipv4` 选项

![](assets/images/2020/03/配置8.png)

选择静态分配ip地址，ip地址填写软路由ip后面的网段即可，即最后面的数字比软路由的33大就行，
但要小于255。如，我这里填写的ip地址为：192.168.123.88。子网掩码填：255.255.255.0。
默认网关填软路由的ip地址：192.168.123.33 。dns和之前一样，可填可不填。然后点确定，
电脑会先断网再自动重新联网，如果重新连上网了，就说明所有配置成功了，正在使用软路由
进行上网。其他设备的配置方法也是一样的，使用静态分配ip，按照上面的方式填写就可以使用
软路由进行上网了。

![](assets/images/2020/03/配置9.png)

后续如果在软路由中配置科学上网插件，广告屏蔽插件等后，连接软路由的设备就可以直接科学
上网和屏蔽广告了。

本教程只针对虚拟机软路由的搭建与配置，关于科学上网插件及其他插件的安装与配置另外再
做教程。



















