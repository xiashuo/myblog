<div class="blog-article">
    <h1><a href="p.html?p=\python\基于pyqt5的mask转伪彩色图像工具" class="title">基于pyqt5的mask转伪彩色图像工具</a></h1>
    <span class="author">xiashuobad</span>
    <span class="time">2021-01-11 15:08</span>
    <span><a href="tags.html?t=python" class="tag">python</a></span>
    </div><br/>
> 由于软件标注数据导出的mask标签(索引值图像，肉眼看上去就是全黑)，不方便检测标注准确性，还有分割模型的输出也是类似的索引值，为了方便显示，抽空写了个带界面的转换工具，方便数据组使用。工具是用pyqt5做的，然后通过nuitka打包成exe

## 使用QTDesigner工具设计界面

> 这个工具还是挺方便的，关于pyqt5里的控件，布局什么的和其他语言都类似，挺好上手的。设计完界面，可以自动导出成python代码

### 安装QTDesigner和PyUIC工具

`pip install pyqt5`

`pip install pyqt5-tools`

安装上面两个包后，这两个工具就会自动安装

### 将QtDesigner和PyUIC链接到PyCharm的外部工具库

点击PyCharm的`File->Settings->Tools->External tools`打开外部工具界面，点`‘+'`号进入添加外部工具界面。在`‘Name'`处输入工具名称，这个名称可以随便取，只要自己清楚就行，我这里写的是Qt designer。然后，找到安装的designer.exe所在的路径（一般在python安装目录下的`Lib\site-packages\pyqt5_tools`文件夹里），将其路径复制到`‘Programs'`处，注意要包含designer.exe的文件名。Working directory处设置自己的工作路径，qtdesigner生成的ui文件会默认保存在该路径。`‘Arguments'`不用设置，确认即可。

接下来，按同样的方法添加`pyuic`，pyuic用于将qtdesigner生成的.ui文件转换成python可以识别的.py文件。其设置过程如下图所示，Programs处输入python.exe所在的路径和文件名，Arguments处输入：`-``m PyQt5.uic.pyuic ``-``o $FileNameWithoutExtension$.py $FileName$`，在Working directory处输入：`$FileDir$`，这样生成的py文件就会和被转换的ui文件位于相同的文件夹下。点击ok完成设置。

### 设计界面截图

![](assets/images/2021/01/mask转伪彩色工具设计界面.png)

### PyUIC导出的python界面代码

`mask2render2merge_ui.py`

```python
# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'mask2render2merge.ui'
#
# Created by: PyQt5 UI code generator 5.15.1
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets


class Ui_mainWindow(object):
    def setupUi(self, mainWindow):
        mainWindow.setObjectName("mainWindow")
        mainWindow.resize(633, 578)
        self.centralwidget = QtWidgets.QWidget(mainWindow)
        self.centralwidget.setObjectName("centralwidget")
        self.gridLayout_2 = QtWidgets.QGridLayout(self.centralwidget)
        self.gridLayout_2.setObjectName("gridLayout_2")
        self.gridLayout = QtWidgets.QGridLayout()
        self.gridLayout.setContentsMargins(30, 20, 80, 20)
        self.gridLayout.setSpacing(20)
        self.gridLayout.setObjectName("gridLayout")
        self.lineEdit_2 = QtWidgets.QLineEdit(self.centralwidget)
        self.lineEdit_2.setEnabled(False)
        self.lineEdit_2.setObjectName("lineEdit_2")
        self.gridLayout.addWidget(self.lineEdit_2, 1, 2, 1, 1)
        self.toolButton_2 = QtWidgets.QToolButton(self.centralwidget)
        self.toolButton_2.setObjectName("toolButton_2")
        self.gridLayout.addWidget(self.toolButton_2, 1, 3, 1, 1)
        self.progressBar = QtWidgets.QProgressBar(self.centralwidget)
        self.progressBar.setProperty("value", 0)
        self.progressBar.setObjectName("progressBar")
        self.gridLayout.addWidget(self.progressBar, 7, 2, 1, 1)
        self.label = QtWidgets.QLabel(self.centralwidget)
        self.label.setAlignment(QtCore.Qt.AlignRight | QtCore.Qt.AlignTrailing | QtCore.Qt.AlignVCenter)
        self.label.setObjectName("label")
        self.gridLayout.addWidget(self.label, 0, 1, 1, 1)
        self.lineEdit = QtWidgets.QLineEdit(self.centralwidget)
        self.lineEdit.setEnabled(False)
        self.lineEdit.setObjectName("lineEdit")
        self.gridLayout.addWidget(self.lineEdit, 0, 2, 1, 1)
        self.verticalLayout = QtWidgets.QVBoxLayout()
        self.verticalLayout.setContentsMargins(-1, 0, -1, 10)
        self.verticalLayout.setObjectName("verticalLayout")
        self.horizontalLayout = QtWidgets.QHBoxLayout()
        self.horizontalLayout.setContentsMargins(50, -1, 50, -1)
        self.horizontalLayout.setSpacing(20)
        self.horizontalLayout.setObjectName("horizontalLayout")
        self.pushButton_2 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_2.setObjectName("pushButton_2")
        self.horizontalLayout.addWidget(self.pushButton_2)
        self.pushButton = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton.setObjectName("pushButton")
        self.horizontalLayout.addWidget(self.pushButton)
        self.verticalLayout.addLayout(self.horizontalLayout)
        self.gridLayout.addLayout(self.verticalLayout, 5, 2, 1, 1)
        self.tableWidget = QtWidgets.QTableWidget(self.centralwidget)
        self.tableWidget.setAutoFillBackground(False)
        self.tableWidget.setSelectionBehavior(QtWidgets.QAbstractItemView.SelectRows)
        self.tableWidget.setTextElideMode(QtCore.Qt.ElideRight)
        self.tableWidget.setShowGrid(True)
        self.tableWidget.setRowCount(9)
        self.tableWidget.setColumnCount(3)
        self.tableWidget.setObjectName("tableWidget")
        item = QtWidgets.QTableWidgetItem()
        item.setTextAlignment(QtCore.Qt.AlignCenter)
        item.setFlags(
            QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(0, 0, item)
        item = QtWidgets.QTableWidgetItem()
        item.setTextAlignment(QtCore.Qt.AlignCenter)
        item.setFlags(
            QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(0, 1, item)
        item = QtWidgets.QTableWidgetItem()
        item.setTextAlignment(QtCore.Qt.AlignCenter)
        item.setFlags(
            QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(0, 2, item)
        item = QtWidgets.QTableWidgetItem()
        item.setFlags(
            QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(1, 0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(1, 1, item)
        item = QtWidgets.QTableWidgetItem()
        item.setTextAlignment(QtCore.Qt.AlignCenter)
        self.tableWidget.setItem(1, 2, item)
        item = QtWidgets.QTableWidgetItem()
        item.setFlags(
            QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(2, 0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(2, 1, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(2, 2, item)
        item = QtWidgets.QTableWidgetItem()
        item.setFlags(
            QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(3, 0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(3, 1, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(3, 2, item)
        item = QtWidgets.QTableWidgetItem()
        item.setFlags(
            QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(4, 0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(4, 1, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(4, 2, item)
        item = QtWidgets.QTableWidgetItem()
        item.setFlags(
            QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(5, 0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(5, 1, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(5, 2, item)
        item = QtWidgets.QTableWidgetItem()
        item.setFlags(
            QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(6, 0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(6, 1, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(6, 2, item)
        item = QtWidgets.QTableWidgetItem()
        item.setFlags(
            QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(7, 0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(7, 1, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(7, 2, item)
        item = QtWidgets.QTableWidgetItem()
        item.setFlags(
            QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsDragEnabled | QtCore.Qt.ItemIsDropEnabled | QtCore.Qt.ItemIsUserCheckable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(8, 0, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(8, 1, item)
        item = QtWidgets.QTableWidgetItem()
        self.tableWidget.setItem(8, 2, item)
        self.tableWidget.horizontalHeader().setVisible(False)
        self.tableWidget.horizontalHeader().setCascadingSectionResizes(False)
        self.tableWidget.horizontalHeader().setDefaultSectionSize(110)
        self.tableWidget.horizontalHeader().setSortIndicatorShown(False)
        self.tableWidget.horizontalHeader().setStretchLastSection(False)
        self.tableWidget.verticalHeader().setVisible(False)
        self.tableWidget.verticalHeader().setCascadingSectionResizes(False)
        self.tableWidget.verticalHeader().setStretchLastSection(False)
        self.gridLayout.addWidget(self.tableWidget, 4, 2, 1, 1)
        self.label_2 = QtWidgets.QLabel(self.centralwidget)
        self.label_2.setAlignment(QtCore.Qt.AlignRight | QtCore.Qt.AlignTrailing | QtCore.Qt.AlignVCenter)
        self.label_2.setObjectName("label_2")
        self.gridLayout.addWidget(self.label_2, 1, 1, 1, 1)
        self.pushButton_3 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_3.setObjectName("pushButton_3")
        self.gridLayout.addWidget(self.pushButton_3, 6, 2, 1, 1)
        self.toolButton = QtWidgets.QToolButton(self.centralwidget)
        self.toolButton.setObjectName("toolButton")
        self.gridLayout.addWidget(self.toolButton, 0, 3, 1, 1)
        self.label_3 = QtWidgets.QLabel(self.centralwidget)
        self.label_3.setText("")
        self.label_3.setObjectName("label_3")
        self.gridLayout.addWidget(self.label_3, 7, 1, 1, 1)
        self.gridLayout_2.addLayout(self.gridLayout, 0, 0, 1, 1)
        mainWindow.setCentralWidget(self.centralwidget)

        self.retranslateUi(mainWindow)
        QtCore.QMetaObject.connectSlotsByName(mainWindow)

    def retranslateUi(self, mainWindow):
        _translate = QtCore.QCoreApplication.translate
        mainWindow.setWindowTitle(_translate("mainWindow", "masks转换工具"))
        self.toolButton_2.setText(_translate("mainWindow", "..."))
        self.label.setText(_translate("mainWindow", "images目录："))
        self.pushButton_2.setText(_translate("mainWindow", "添加分类"))
        self.pushButton.setText(_translate("mainWindow", "删除分类"))
        __sortingEnabled = self.tableWidget.isSortingEnabled()
        self.tableWidget.setSortingEnabled(False)
        item = self.tableWidget.item(0, 0)
        item.setText(_translate("mainWindow", "id值"))
        item = self.tableWidget.item(0, 1)
        item.setText(_translate("mainWindow", "分类"))
        item = self.tableWidget.item(0, 2)
        item.setText(_translate("mainWindow", "颜色"))
        item = self.tableWidget.item(1, 0)
        item.setText(_translate("mainWindow", "0"))
        item = self.tableWidget.item(1, 1)
        item.setText(_translate("mainWindow", "无分类"))
        item = self.tableWidget.item(2, 0)
        item.setText(_translate("mainWindow", "1"))
        item = self.tableWidget.item(2, 1)
        item.setText(_translate("mainWindow", "建筑"))
        item = self.tableWidget.item(3, 0)
        item.setText(_translate("mainWindow", "2"))
        item = self.tableWidget.item(3, 1)
        item.setText(_translate("mainWindow", "道路"))
        item = self.tableWidget.item(4, 0)
        item.setText(_translate("mainWindow", "3"))
        item = self.tableWidget.item(4, 1)
        item.setText(_translate("mainWindow", "耕地"))
        item = self.tableWidget.item(5, 0)
        item.setText(_translate("mainWindow", "4"))
        item = self.tableWidget.item(5, 1)
        item.setText(_translate("mainWindow", "林地"))
        item = self.tableWidget.item(6, 0)
        item.setText(_translate("mainWindow", "5"))
        item = self.tableWidget.item(6, 1)
        item.setText(_translate("mainWindow", "植被"))
        item = self.tableWidget.item(7, 0)
        item.setText(_translate("mainWindow", "6"))
        item = self.tableWidget.item(7, 1)
        item.setText(_translate("mainWindow", "湿地"))
        item = self.tableWidget.item(8, 0)
        item.setText(_translate("mainWindow", "7"))
        item = self.tableWidget.item(8, 1)
        item.setText(_translate("mainWindow", "水域"))
        self.tableWidget.setSortingEnabled(__sortingEnabled)
        self.label_2.setText(_translate("mainWindow", "masks目录："))
        self.pushButton_3.setText(_translate("mainWindow", "转换并拼接"))
        self.toolButton.setText(_translate("mainWindow", "..."))

```

## mask转伪彩色图像代码

```python
    def mask2render(self, masks_dir, renders_dir):
        '''
        将mask图片转换成灰度渲染图片，方便检查样本标注错误
        :param masks_dir: mask图片所在目录
        :param renders_dir: 灰度渲染图片输出目录
        :param class_num: 总分类数（不包括背景）
        :return:
        '''
        self.step = 0
        if not os.path.exists(renders_dir):
            os.makedirs(renders_dir)
        masks_list = os.listdir(masks_dir)
        self.progressBar.setMaximum(len(masks_list))
        for mask_file in masks_list:
            mask_file_path = os.path.join(masks_dir, mask_file)
            mask = np.array(Image.open(mask_file_path))
            mask[mask == 255] = 0
            mask = Image.fromarray(mask, mode='L')
            mask.putpalette(self.color_list)
            color_image_path = os.path.join(renders_dir, mask_file)
            mask.save(color_image_path)
            self.step += 1
            self.progressBar.setValue(self.step)
```

## 训练图片与转换后的伪彩色标签拼接代码

```python
    def merge_img_render(self, imgdir, maskdir, dist_dir):
        '''
        将img与maks渲染后的render图片进行水平拼接，方便检查样本标注错误
        :param all_dirs: img和render所在目录
        :param dist_dir: 拼接后输出目录
        :return:
        '''
        if not os.path.exists(dist_dir):
            os.makedirs(dist_dir)
        imglists = os.listdir(imgdir)
        self.step = 0
        self.progressBar.setValue(self.step)
        for imgname in imglists:
            imgpath = os.path.join(imgdir, imgname)
            maskpath = os.path.join(maskdir, imgname)
            img = cv2.imdecode(np.fromfile(imgpath, dtype=np.uint8), cv2.IMREAD_COLOR) if not imgname.endswith(
                '.tif') else tifffile.imread(imgpath)[:, :, :3]
            mask = cv2.imdecode(np.fromfile(maskpath, dtype=np.uint8), cv2.IMREAD_COLOR)
            hstack_list = []
            hstack_list.append(img)
            hstack_list.append(mask)
            merge_img = np.hstack(hstack_list)
            distpath = os.path.join(dist_dir, imgname)
            cv2.imencode(ext='.tif', img=merge_img)[1].tofile(distpath)
            self.step += 1
            self.progressBar.setValue(self.step)
```

## 完整main.py代码

```python
# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'mask2render2merge.ui'
#
# Created by: PyQt5 UI code generator 5.15.1
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.
import os
import sys

import cv2
import tifffile
from PIL import Image
from PyQt5 import QtCore
from PyQt5.QtWidgets import QApplication, QMainWindow, QFileDialog, QMessageBox, QPushButton, QColorDialog, \
    QTableWidgetItem
import numpy as np
from mask2render2merge_ui import Ui_mainWindow

Image.MAX_IMAGE_PIXELS=None

class MyWindow(QMainWindow, Ui_mainWindow):
    default_dir = '/home'
    style_sheet = 'background-color:rgb({},{},{});margin-left:35;margin-right:35;margin-top:5;margin-bottom:5;'
    color_list = [
        0, 0, 0,  # 黑色，背景
        224, 64, 64,  # 红色，建筑
        96, 96, 96,  # 灰色，道路
        96, 160, 32,  # 浅绿色，耕地
        32, 64, 0,  # 深绿色，林地
        192, 192, 64,  # 橙黄色，植被
        128, 164, 164,  # 灰绿色，湿地
        32, 224, 224,  # 浅蓝色，水域
    ]

    def __init__(self, parent=None):
        super(MyWindow, self).__init__(parent)
        self.init_ui()
        self.bind_event()

    def init_ui(self):
        self.setupUi(self)
        for i in range(0, len(self.color_list), 3):
            button_color = QPushButton()
            button_color.setStyleSheet(self.style_sheet.format(*self.color_list[i:i + 3]))
            button_color.clicked.connect(self.select_color)
            self.tableWidget.setCellWidget(i // 3 + 1, 2, button_color)

    def bind_event(self):
        '''
        绑定事件
        :param ui:
        :return:
        '''
        self.toolButton.clicked.connect(self.select_img_dir)
        self.toolButton_2.clicked.connect(self.select_mask_dir)
        self.pushButton.clicked.connect(self.delete_class)
        self.pushButton_2.clicked.connect(self.add_class)
        self.pushButton_3.clicked.connect(self.mask2render2merge)

    def delete_class(self):
        row_count = self.tableWidget.rowCount()
        try:
            row_selected = self.tableWidget.selectedItems()[0].row()
            self.tableWidget.removeRow(row_selected)
            del self.color_list[(row_selected - 1) * 3:(row_selected - 1) * 3 + 3]
            # print(self.color_list)
            for row in range(row_selected, row_count - 1):
                self.tableWidget.item(row, 0).setText(str(row - 1))
        except Exception:
            QMessageBox.information(self, '提示', '未选择任何分类选项！')

    def add_class(self):
        count_table_row = self.tableWidget.rowCount()
        button_color = QPushButton()
        button_color.setStyleSheet(self.style_sheet.format(*(0, 0, 0)))
        button_color.clicked.connect(self.select_color)
        item1 = QTableWidgetItem(f'{count_table_row - 1}')
        item2 = QTableWidgetItem(f'分类{count_table_row - 1}')
        self.tableWidget.insertRow(count_table_row)
        self.tableWidget.setItem(count_table_row, 0, item1)
        self.tableWidget.item(count_table_row, 0).setFlags(QtCore.Qt.ItemIsSelectable | QtCore.Qt.ItemIsEnabled)
        self.tableWidget.setItem(count_table_row, 1, item2)
        self.tableWidget.setCellWidget(count_table_row, 2, button_color)
        self.color_list.extend([0, 0, 0])
        # print(self.color_list)

    def select_color(self):
        color = QColorDialog.getColor(title='选择分类颜色')
        sender = self.sender()
        id = int(self.tableWidget.selectedItems()[0].text())
        r, g, b, a = color.getRgb()
        self.color_list[id * 3], self.color_list[id * 3 + 1], self.color_list[id * 3 + 2] = r, g, b
        sender.setStyleSheet(self.style_sheet.format(r, g, b))

    def mask2render2merge(self):
        try:
            img_dir = self.lineEdit.text()
            mask_dir = self.lineEdit_2.text()
            render_dir = os.path.join(os.path.dirname(mask_dir), 'renders')
            self.label_3.setText('mask转换中...')
            self.mask2render(mask_dir, render_dir)
            self.label_3.setText('mask转换完成')
            dist_dir = os.path.join(os.path.dirname(mask_dir), 'mask2check')
            self.label_3.setText('mask拼接中...')
            self.merge_img_render(img_dir, render_dir, dist_dir)
            self.label_3.setText('mask拼接完成')
            QMessageBox.information(self, '提示', 'mask转换拼接完成！文件输出在mask同级目录下')
        except ValueError:
            QMessageBox.critical(self, '错误', '输入错误！')
        except Exception as e:
            QMessageBox.critical(self, '错误', str(type(e)))

    def select_img_dir(self):
        dir_name = QFileDialog.getExistingDirectory(directory=self.default_dir)
        if dir_name:
            self.lineEdit.setText(dir_name)
            self.default_dir = dir_name

    def select_mask_dir(self):
        dir_name = QFileDialog.getExistingDirectory(directory=self.default_dir)
        if dir_name:
            self.lineEdit_2.setText(dir_name)
            self.default_dir = dir_name

    def mask2render(self, masks_dir, renders_dir):
        '''
        将mask图片转换成灰度渲染图片，方便检查样本标注错误
        :param masks_dir: mask图片所在目录
        :param renders_dir: 灰度渲染图片输出目录
        :param class_num: 总分类数（不包括背景）
        :return:
        '''
        self.step = 0
        if not os.path.exists(renders_dir):
            os.makedirs(renders_dir)
        masks_list = os.listdir(masks_dir)
        self.progressBar.setMaximum(len(masks_list))
        for mask_file in masks_list:
            mask_file_path = os.path.join(masks_dir, mask_file)
            mask = np.array(Image.open(mask_file_path))
            mask[mask == 255] = 0
            mask = Image.fromarray(mask, mode='L')
            mask.putpalette(self.color_list)
            color_image_path = os.path.join(renders_dir, mask_file)
            mask.save(color_image_path)
            self.step += 1
            self.progressBar.setValue(self.step)

    def merge_img_render(self, imgdir, maskdir, dist_dir):
        '''
        将img与maks渲染后的render图片进行水平拼接，方便检查样本标注错误
        :param all_dirs: img和render所在目录
        :param dist_dir: 拼接后输出目录
        :return:
        '''
        if not os.path.exists(dist_dir):
            os.makedirs(dist_dir)
        imglists = os.listdir(imgdir)
        self.step = 0
        self.progressBar.setValue(self.step)
        for imgname in imglists:
            imgpath = os.path.join(imgdir, imgname)
            maskpath = os.path.join(maskdir, imgname)
            img = cv2.imdecode(np.fromfile(imgpath, dtype=np.uint8), cv2.IMREAD_COLOR) if not imgname.endswith(
                '.tif') else tifffile.imread(imgpath)[:, :, :3]
            mask = cv2.imdecode(np.fromfile(maskpath, dtype=np.uint8), cv2.IMREAD_COLOR)
            hstack_list = []
            hstack_list.append(img)
            hstack_list.append(mask)
            merge_img = np.hstack(hstack_list)
            distpath = os.path.join(dist_dir, imgname)
            cv2.imencode(ext='.tif', img=merge_img)[1].tofile(distpath)
            self.step += 1
            self.progressBar.setValue(self.step)


def main():
    app = QApplication(sys.argv)
    myWin = MyWindow()
    myWin.show()
    sys.exit(app.exec_())


if __name__ == '__main__':
    main()

```

## 使用nuitka进行项目打包

打包命令：`nuitka --standalone --mingw64 --nofollow-imports --follow-import-to=mask2render2merge_ui --plugin-enable=qt-plugins --windows-disable-console --show-progress --show-scons --output-dir=output main.py` 

## 运行结果

![](assets/images/2021/01/mask转伪彩色工具截图.png)

![](assets/images/2021/01/mask转伪彩色工具截图2.png)

![](assets/images/2021/01/mask转伪彩色工具截图3.png)